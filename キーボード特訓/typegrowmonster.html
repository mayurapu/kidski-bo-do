<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ÊØçÈü≥ÔºÜ„É≠„Éº„ÉûÂ≠ó„É¢„É≥„Çπ„Çø„Éº</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
            background-color: #fff0f5;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; overflow-y: auto;
            transition: background-color 1s ease;
        }
        body.stage2-bg { background-color: #f0f0ff; }
        body.stage3-bg { background-color: #fffaf0; }

        #game-container {
            text-align: center; background: white; padding: 30px;
            border-radius: 30px; box-shadow: 0 15px 40px rgba(255, 105, 180, 0.3);
            width: 700px; position: relative; margin-bottom: 40px;
        }
        #speech-bubble { font-size: 1.4em; font-weight: bold; color: #ff1493; height: 1.5em; margin-bottom: 10px; }

        #monster-area {
            height: 220px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-bottom: 10px; position: relative;
        }

        #evolution-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; border-radius: 30px; opacity: 0; pointer-events: none;
            z-index: 10;
        }
        .flash-active { animation: flash-anim 0.8s ease-out; }
        @keyframes flash-anim {
            0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; }
        }

        #evolution-banner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 80px; font-weight: bold; color: #ff1493; text-shadow: 3px 3px 0 white;
            white-space: nowrap; opacity: 0; pointer-events: none; z-index: 11;
        }
        .banner-active { animation: banner-anim 1.5s ease-in-out; }
        @keyframes banner-anim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        #monster {
            width: 40px; height: 100px; background-color: #ddd;
            transition: all 0.3s ease-in-out;
            border-radius: 10px; position: relative;
            display: flex; justify-content: center; align-items: center;
            z-index: 2;
        }
        #monster-shadow {
            width: 50px; height: 10px; background: rgba(0,0,0,0.1);
            border-radius: 50%; margin-top: 15px;
            transition: all 0.3s ease-in-out;
            filter: blur(2px);
        }

        .eye { position: absolute; top: 25%; width: 10px; height: 10px; background: #333; border-radius: 50%; }
        .eye-l { left: 20%; } .eye-r { right: 20%; }
        .mouth { position: absolute; bottom: 20%; width: 20px; height: 10px; border-bottom: 3px solid #333; border-radius: 0 0 10px 10px; }

        .eye-closed { height: 2px !important; border-radius: 0 !important; }
        .eye-big { width: 15px !important; height: 15px !important; }
        .mouth-open { height: 15px !important; background: #333 !important; border-radius: 50% !important; }
        .mouth-flat { border-bottom: 3px solid #333 !important; border-radius: 0 !important; height: 0 !important; }

        .lv0 { width: 30px !important; height: 100px !important; }
        .lv1 { width: 80px !important; height: 80px !important; border-radius: 50% !important; }
        .lv2 { width: 80px !important; height: 80px !important; transform: skew(15deg); border-radius: 5px !important; }
        .lv3 { width: 100px !important; height: 100px !important; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); border-radius: 0 !important; }
        .lv4 { width: 150px !important; height: 80px !important; border-radius: 20px !important; }
        .lv5 { width: 120px !important; height: 120px !important; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }
        .lv6 { width: 100px !important; height: 100px !important; transform: rotate(45deg); border-radius: 0 !important; }
        .lv7 { width: 120px !important; height: 120px !important; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .lv8 { border: 8px double #ff1493 !important; width: 140px !important; height: 140px !important; border-radius: 30% !important; }
        .lv9 { width: 150px !important; height: 150px !important; box-shadow: 0 0 40px #ff69b4; border-radius: 50% !important; }
        .lv10 { animation: grow 1s infinite alternate; filter: hue-rotate(10deg); border-radius: 20px !important; }
        .legendary { box-shadow: 0 0 60px #ffd700 !important; border: 10px gold double !important; transform: scale(1.1) !important; }

        .rare-effect {
            animation: rainbow 2s linear infinite !important;
            box-shadow: 0 0 30px #fff, 0 0 50px #ff00de !important;
        }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        @keyframes grow { from { transform: scale(1); } to { transform: scale(1.1); } }

        #target-display { font-size: 60px; color: #ffb6c1; font-weight: bold; line-height: 1.2; height: 120px; }
        #target-kana { font-size: 30px; color: #ff69b4; }
        .next-key { color: #ff1493; transform: scale(1.1); display: inline-block; }
        .done-key { color: #eee; }

        #keyboard { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 15px; }
        .row { display: flex; gap: 5px; }
        .key { width: 45px; height: 45px; border: 2px solid #ffecf0; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; background: #fafafa; color: transparent; }
        .key.visible { color: #ffc0cb; }
        .key.target-hint { border-color: #ff69b4; color: #ff69b4; background-color: #fff0f5; }

        #name-form, #final-screen { display: none; }
        input { width: 80%; margin: 5px; padding: 10px; border: 2px solid #ffb6c1; border-radius: 10px; font-size: 14px; }
        button { background: #ff69b4; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        .result-box { background: #fffaf0; border: 3px solid #ffb6c1; border-radius: 20px; padding: 20px; margin-top: 10px; text-align: left; }
        .res-item { color: #ff1493; font-weight: bold; font-size: 0.9em; margin-top: 8px; }
        .res-val { color: #333; border-bottom: 1px dashed #ffb6c1; padding-bottom: 2px; font-size: 1.1em; margin-bottom: 5px; }

        #collection-container { width: 700px; background: white; border-radius: 30px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; margin-top: 15px; }
        .mini-monster { 
            border: 2px solid #ffecf0; border-radius: 15px; padding: 10px; text-align: center; font-size: 10px; background: #fffafb;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .mini-shape { transform: scale(0.4); margin: -20px 0; }
        .rare-badge { position: absolute; top: 5px; right: 5px; background: linear-gradient(45deg, gold, orange); color: white; font-size: 8px; padding: 2px 5px; border-radius: 10px; font-weight: bold; }

        #reward-area { background: #fff0f5; border: 2px dashed #ff69b4; border-radius: 20px; padding: 15px; margin-bottom: 20px; text-align: center; }
        .reward-badge { font-size: 1.2em; font-weight: bold; color: #ff1493; margin-bottom: 5px; }
        .reward-progress { color: #666; font-size: 0.9em; }

        #story-overlay {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 15px 25px; border-radius: 20px;
            box-shadow: 0 5px 20px rgba(255, 105, 180, 0.2);
            font-size: 1.1em; color: #ff1493; font-weight: bold; line-height: 1.6;
            text-align: center; max-width: 600px; z-index: 1000;
            opacity: 1; transition: opacity 1s ease-out;
            border: 2px solid #ffb6c1;
        }
        #story-overlay.hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="story-overlay">
    „ÅäËÖπ„Å∫„Åì„Å∫„Åì„ÅÆ„É¢„É≥„Çπ„Çø„Éº„Åå„ÅÑ„Åæ„Åô„ÄÇ<br>
    „Åæ„Å†„ÅÇ„Åã„Å°„ÇÉ„Çì„Å†„Åã„ÇâÊØçÈü≥ÔºàAIUEOÔºâ„Åó„ÅãÈ£ü„Åπ„Çâ„Çå„Å™„ÅÑ„Åø„Åü„ÅÑ„ÄÇ<br>
    ÊØçÈü≥„Çí„ÅÇ„Åí„Å¶„ÄÅÂ§ß„Åç„ÅèËÇ≤„Å¶„Å¶„ÅÇ„Åí„Å¶„Å≠ÔºÅ
</div>

<div id="game-container">
    <div id="evolution-flash"></div>
    <div id="evolution-banner">LEVEL UP!</div>

    <div id="play-screen">
        <div id="speech-bubble">„ÅØ„Åò„Åæ„Çã„Å£„Å¥ÔºÅ</div>
        <div id="monster-area">
            <div id="monster" class="lv0">
                <div class="eye eye-l"></div><div class="eye eye-r"></div>
                <div class="mouth"></div>
            </div>
            <div id="monster-shadow"></div>
        </div>
        <div id="target-display">
            <div id="target-letters"></div>
            <div id="target-kana"></div>
        </div>
        <div id="score-board" style="color:#ff69b4; font-weight:bold; margin: 10px 0;"></div>
        <div id="keyboard">
            <div class="row" id="row1"></div><div class="row" id="row2"></div><div class="row" id="row3"></div>
        </div>
    </div>

    <div id="name-form">
        <div id="form-monster-container" style="height:180px; display:flex; flex-direction:column; justify-content:center; align-items:center;"></div>
        <h2 id="name-form-title" style="color: #ff1493;">‚ú® „Åó„Çì„Åã „Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</h2>
        <input type="text" id="m-name" placeholder="„Å™„Åæ„Åà„Çí „Å§„Åë„Å¶„Å≠"><br>
        <input type="text" id="m-prof" placeholder="„Å©„Çì„Å™ „Åõ„ÅÑ„Åã„Åè„Åã„Å™Ôºü"><br>
        <input type="text" id="m-skill" placeholder="„Å©„Çì„Å™ „ÅÆ„ÅÜ„Çä„Çá„Åè„Åå „ÅÇ„Çã„Åã„Å™Ôºü"><br>
        <button id="go-stage3-btn">„Å™„Åæ„Åà„ÇíÊ±∫ÂÆö„Åó„Å¶ ‰øÆË°å„Å´„ÅÑ„ÅèÔºÅ</button>
    </div>

    <div id="final-screen">
        <h2 id="res-shogo" style="color: #ff1493; margin: 0;"></h2>
        <div id="final-monster-container" style="height:180px; display:flex; flex-direction:column; justify-content:center; align-items:center;"></div>
        <div class="result-box">
            <div class="res-item">„Äê„Å™„Åæ„Åà„Äë</div><div id="res-name" class="res-val"></div>
            <div class="res-item">„Äê„Åõ„ÅÑ„Åã„Åè„Äë</div><div id="res-prof" class="res-val"></div>
            <div class="res-item">„Äê„ÅÆ„ÅÜ„Çä„Çá„Åè„Äë</div><div id="res-skill" class="res-val"></div>
            <div class="res-item">üïí „Äê„Åù„Å†„Å¶„ÅüÊôÇÈñì„Äë</div><div id="res-time" class="res-val"></div>
        </div>
        <button onclick="location.reload()">„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑ „Åù„Å†„Å¶„Çã</button>
    </div>
</div>

<div id="collection-container">
    <h3 style="color: #ff69b4; margin-top: 0;">üíñ Ê≠¥‰ª£„É¢„É≥„Çπ„Çø„Éº„Åö„Åã„Çì</h3>
    <div id="reward-area">
        <div id="reward-badge" class="reward-badge">Áß∞Âè∑Ôºö„Åü„Åæ„Åî„Éñ„É™„Éº„ÉÄ„Éºü•ö</div>
        <div id="reward-progress" class="reward-progress">„ÅÇ„Å® 3Âåπ „ÅßÊñ∞„Åó„ÅÑ„ÅîË§íÁæé„Å†„Å£„Å¥ÔºÅ</div>
    </div>
    <div id="collection-grid" class="collection-grid"></div>
    <button onclick="clearCollection()" style="background: #ccc; font-size: 10px; padding: 5px 10px; margin-top: 20px; border-radius: 10px;">„Åö„Åã„Çì„Çí„É™„Çª„ÉÉ„Éà</button>
</div>

<script>
    const monster = document.getElementById('monster');
    const shadow = document.getElementById('monster-shadow');
    const eyeL = document.querySelector('.eye-l');
    const eyeR = document.querySelector('.eye-r');
    const mouth = document.querySelector('.mouth');
    const speech = document.getElementById('speech-bubble');
    const scoreBoard = document.getElementById('score-board');
    const targetLettersEl = document.getElementById('target-letters');
    const targetKanaEl = document.getElementById('target-kana');
    const storyOverlay = document.getElementById('story-overlay');
    const flashEl = document.getElementById('evolution-flash');
    const bannerEl = document.getElementById('evolution-banner');

    const vowels = { 'A':'„ÅÇ','I':'„ÅÑ','U':'„ÅÜ','E':'„Åà','O':'„Åä' };
    
    // ‚ñº „Åì„Åì„Å´„Äå„ÇÑ„ÇÜ„ÇàÔºàYA, YU, YOÔºâ„Äç„Å®„Äå„Çè„Çí„ÇìÔºàWA, WO, NNÔºâ„Äç„ÇíËøΩÂä†„Åó„Åü„ÇàÔºÅ
    const romaTable = { 
        'KA':'„Åã','KI':'„Åç','KU':'„Åè','KE':'„Åë','KO':'„Åì',
        'SA':'„Åï','SI':'„Åó','SU':'„Åô','SE':'„Åõ','SO':'„Åù',
        'TA':'„Åü','TI':'„Å°','TU':'„Å§','TE':'„Å¶','TO':'„Å®',
        'NA':'„Å™','NI':'„Å´','NU':'„Å¨','NE':'„Å≠','NO':'„ÅÆ',
        'HA':'„ÅØ','HI':'„Å≤','HU':'„Åµ','HE':'„Å∏','HO':'„Åª',
        'MA':'„Åæ','MI':'„Åø','MU':'„ÇÄ','ME':'„ÇÅ','MO':'„ÇÇ',
        'YA':'„ÇÑ','YU':'„ÇÜ','YO':'„Çà',
        'RA':'„Çâ','RI':'„Çä','RU':'„Çã','RE':'„Çå','RO':'„Çç',
        'WA':'„Çè','WO':'„Çí','NN':'„Çì' 
    };
    
    const wordList = [
        {k:"„Çä„Çì„Åî",r:"RINNGO"},{k:"„Å≠„Åì",r:"NEKO"},{k:"„ÅÜ„Åø",r:"UMI"},{k:"„Åª„Åó",r:"HOSI"},
        {k:"„ÅØ„Å™",r:"HANA"},{k:"„Åô„ÅÑ„Åã",r:"SUIKA"},{k:"„Åè„Çã„Åæ",r:"KURUMA"},{k:"„Å®„Åæ„Å®",r:"TOMATO"},
        {k:"„Å≤„Åã„Çä",r:"HIKARI"},{k:"„Åæ„Çì„Åå",r:"MANNGA"},{k:"„ÅÑ„Å°„Åî",r:"ITIGO"},{k:"„Åà„Çì„Å¥„Å§",r:"ENNPITU"},
        {k:"„Åä„Åã„Åó",r:"OKASI"},{k:"„Åç„ÇÇ„ÅÆ",r:"KIMONO"},{k:"„Åè„Åò„Çâ",r:"KUDIRA"},{k:"„Åë„ÇÄ„Çä",r:"KEMURI"},
        {k:"„Åì„Åì„Çç",r:"KOKORO"},{k:"„Åï„Åã„Å™",r:"SAKANA"},{k:"„Åó„Çì„Å∂„Çì",r:"SINNBUNN"},{k:"„Åô„Åö„ÇÅ",r:"SUZUME"},
        {k:"„Åõ„Åã„ÅÑ",r:"SEKAI"},{k:"„Åù„Çâ",r:"SORA"},{k:"„Åü„Å¨„Åç",r:"TANUKI"},{k:"„Å§„Åè„Åà",r:"TUKUE"},
        {k:"„Å¶„Åå„Åø",r:"TEGAMI"},{k:"„Å®„Åë„ÅÑ",r:"TOKEI"},{k:"„Å™„Å§",r:"NATU"},{k:"„Å´„Åò",r:"NIDI"},
        {k:"„Å≠„Åå„ÅÑ",r:"NEGAI"},{k:"„ÅÆ„Éº„Å®",r:"NO-TO"},{k:"„ÇÑ„Åæ",r:"YAMA"},{k:"„ÇÜ„Åç",r:"YUKI"},
        {k:"„Çà„Çã",r:"YORU"},{k:"„Çè„Å´",r:"WANI"}
    ];

    const keys = [['Q','W','E','R','T','Y','U','I','O','P'],['A','S','D','F','G','H','J','K','L'],['Z','X','C','V','B','N','M']];
    const evolutionMessages = ["„Åü„Å†„ÅÆ„Åº„ÅÜ„Å†„Å£„Å¥‚Ä¶", "„Åæ„Çã„Åè„Å™„Å£„Åü„Å£„Å¥ÔºÅ", "„Åä„Åó„ÇÉ„Çå„Å†„Çè„Äú„Çì‚ô°", "„Åï„Çì„Åã„Åè„Å†„Å£„Å¥ÔºÅ", "„Åó„Åã„Åè„Å†„Å£„Å¥ÔºÅ", "„Åç„Çä„Å£„Å®„Åó„Å¶„Åç„Åü„Å£„Å¥ÔºÅ", "„Åæ„Çè„Å£„Å¶„Çã„Çè„Äú„Çì‚ô°", "„Åç„Çâ„Åç„Çâ„Å†„Å£„Å¥ÔºÅ", "„Ç¥„Éº„Ç∏„É£„Çπ„Å†„Çè„Äú„Çì‚ô°", "„ÇÇ„ÅÜ„Åô„ÅêÁ©∂Ê•µÈÄ≤Âåñ„Å†„Å£„Å¥ÔºÅ", "„ÅÜ„Å°„ÇÖ„ÅÜ„ÅÑ„Å°„Å†„Å£„Å¥„ÉºÔºÅ"];

    let totalCount = 0, stageCount = 0, stage = 1, typedIndex = 0;
    let currentTargetRoma = "", currentTargetKana = "";
    let startTime, monsterName = "", speechTimer;
    let isRare = false;

    keys.forEach((row, i) => {
        const rowEl = document.getElementById(`row${i+1}`);
        row.forEach(k => {
            const el = document.createElement('div');
            el.className = 'key' + (vowels[k] ? ' visible' : '');
            el.id = 'key-' + k;
            el.innerText = k;
            rowEl.appendChild(el);
        });
    });

    function randomAppearance() {
        if (stage >= 2 && !isRare && Math.random() < 0.005) {
            isRare = true;
            monster.classList.add('rare-effect');
        }
        const colors = ['#FF69B4', '#FFD700', '#ADFF2F', '#00BFFF', '#BA55D3', '#FF4500', '#00FA9A', '#FFB6C1'];
        monster.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        eyeL.className = 'eye eye-l'; eyeR.className = 'eye eye-r'; mouth.className = 'mouth';
        const eTypes = ['', 'eye-closed', 'eye-big'];
        const eType = eTypes[Math.floor(Math.random() * eTypes.length)];
        if (eType) { eyeL.classList.add(eType); eyeR.classList.add(eType); }
        const mTypes = ['', 'mouth-open', 'mouth-flat'];
        const mType = mTypes[Math.floor(Math.random() * mTypes.length)];
        if (mType) mouth.classList.add(mType);

        if (stage === 1) {
            const lv = Math.floor(totalCount / 10);
            monster.className = 'lv' + (lv > 10 ? 10 : lv);
            speech.innerText = evolutionMessages[lv > 10 ? 10 : lv];
        } else if (stage === 2) {
            monster.className = 'lv' + Math.floor(Math.random() * 11);
            if (isRare) {
                monster.classList.add('rare-effect');
                speech.innerText = "„Åô„Åî„Åô„Åé„Å†„Çè„Äú„ÇìüíïË∂Ö„É¨„Ç¢„Å†„Å£„Å¥ÔºÅ";
            } else {
                speech.innerText = "„ÇÇ„Å£„Å®ÔºÅ„ÇÇ„Å£„Å®„Åü„Åπ„Çã„Å£„Å¥ÔºÅ";
            }
        } else {
            monster.className = 'lv' + Math.floor(Math.random() * 11);
            monster.classList.add('legendary');
            if (isRare) monster.classList.add('rare-effect');
            speech.innerText = monsterName + "„ÅÆ ‰øÆË°å„Å†„Å£„Å¥ÔºÅ";
        }
        shadow.style.width = (monster.offsetWidth + 20) + "px";
    }

    function playEvolutionEffect(message, nextStage) {
        flashEl.classList.add('flash-active');
        bannerEl.innerText = message;
        bannerEl.classList.add('banner-active');
        
        setTimeout(() => {
            flashEl.classList.remove('flash-active');
            bannerEl.classList.remove('banner-active');
            if (nextStage === 2) document.body.classList.add('stage2-bg');
            if (nextStage === 3) document.body.classList.add('stage3-bg');
            nextStep();
        }, 1500);
    }

    function nextStep() {
        typedIndex = 0;
        if (stage === 1) {
            currentTargetRoma = Object.keys(vowels)[Math.floor(Math.random() * 5)];
            currentTargetKana = vowels[currentTargetRoma];
            scoreBoard.innerHTML = `„Åü„Åπ„Åü„Åã„Åö: <span id="count">${totalCount}</span> / 100`;
        } else if (stage === 2) {
            const romaKeys = Object.keys(romaTable);
            currentTargetRoma = romaKeys[Math.floor(Math.random() * romaKeys.length)];
            currentTargetKana = romaTable[currentTargetRoma];
            // „ÇÑ„ÇÜ„Çà„ÄÅ„Çè„Çí„Çì„ÅåËøΩÂä†„Åï„Çå„Åü„ÅÆ„ÅßÂàÜÊØç„ÇÇÂ∞ë„ÅóÂ¢ó„ÇÑ„Åó„Åü„Å£„Å¥ÔºÅ
            scoreBoard.innerHTML = `Á¨¨Ôºí„Çπ„ÉÜ„Éº„Ç∏ÔºÅ: <span id="count">${stageCount}</span> / 100`;
        } else {
            const word = wordList[Math.floor(Math.random() * wordList.length)];
            currentTargetRoma = word.r;
            currentTargetKana = word.k;
            scoreBoard.innerHTML = `ÊúÄÁµÇ„Çπ„ÉÜ„Éº„Ç∏Ôºö‰øÆË°å: <span id="count">${stageCount}</span> / 10`;
        }
        renderTarget();
    }

    function renderTarget() {
        targetLettersEl.innerHTML = "";
        for (let i = 0; i < currentTargetRoma.length; i++) {
            const span = document.createElement('span');
            span.innerText = currentTargetRoma[i];
            span.className = (i < typedIndex ? 'done-key' : (i === typedIndex ? 'next-key' : ''));
            targetLettersEl.appendChild(span);
        }
        targetKanaEl.innerText = `Ôºà${currentTargetKana}Ôºâ`;
        document.querySelectorAll('.key').forEach(k => k.classList.remove('target-hint'));
        document.getElementById('key-' + currentTargetRoma[typedIndex])?.classList.add('target-hint');
    }

    window.addEventListener('keydown', (e) => {
        if (!storyOverlay.classList.contains('hidden')) storyOverlay.classList.add('hidden');
        if (document.getElementById('name-form').style.display === 'block' || document.getElementById('final-screen').style.display === 'block') return;
        if (bannerEl.classList.contains('banner-active')) return;

        if (!startTime) startTime = new Date();
        const key = e.key.toUpperCase();
        if (key === currentTargetRoma[typedIndex]) {
            clearTimeout(speechTimer);
            typedIndex++;
            if (typedIndex >= currentTargetRoma.length) {
                if (stage === 3) { stageCount++; speech.innerText = `„Äå${currentTargetKana}ÔºÅ„Äç`; }
                else { totalCount++; stageCount++; speech.innerText = "„Éë„ÇØ„ÉÉÔºÅ"; }
                randomAppearance();
                
                if (stage === 1 && totalCount >= 100) {
                    stage = 2; stageCount = 0;
                    document.querySelectorAll('.key').forEach(k => k.classList.add('visible'));
                    playEvolutionEffect("LEVEL UP!!", 2);
                } else if (stage === 2 && stageCount >= 100) { showNameForm(); }
                else if (stage === 3 && stageCount >= 10) { showFinalScreen(); }
                else { setTimeout(nextStep, 200); }
            } else { renderTarget(); }
        } else if (key.length === 1 && /^[A-Z]$/.test(key)) {
            clearTimeout(speechTimer); speech.innerText = "„Å´„Åå„Éº„ÅÑÔºÅ„Å†„Å£„Å¥ÔºÅ";
            speechTimer = setTimeout(() => { randomAppearance(); }, 800);
        }
    });

    function showNameForm() {
        document.getElementById('play-screen').style.display = 'none';
        document.getElementById('name-form').style.display = 'block';
        if (isRare) document.getElementById('name-form-title').innerText = "‚ú® Ë∂Ö„ÉªÊøÄ„É¨„Ç¢„Åó„Çì„Åã „Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ ‚ú®";
        const container = document.getElementById('form-monster-container');
        container.innerHTML = "";
        const mClone = monster.cloneNode(true);
        const sClone = shadow.cloneNode(true);
        container.appendChild(mClone);
        container.appendChild(sClone);
    }

    function showFinalScreen() {
        const diff = (new Date() - startTime) / 1000;
        const prof = document.getElementById('m-prof').value || "„Åµ„ÇÅ„ÅÑ";
        const skill = document.getElementById('m-skill').value || "„Å™„Åó";
        const timeStr = `${Math.floor(diff/60)}ÂàÜ ${(diff%60).toFixed(1)}Áßí`;
        document.getElementById('res-name').innerText = monsterName + (isRare ? "ÔºàË∂Ö„É¨„Ç¢Ôºâ" : "");
        document.getElementById('res-prof').innerText = prof;
        document.getElementById('res-skill').innerText = skill;
        document.getElementById('res-time').innerText = timeStr;
        let shogo = "Áß∞Âè∑Ôºö‚òòÔ∏è „ÅÆ„Çì„Å≥„ÇäËÇ≤ÊàêÂêç‰∫∫";
        if (diff < 200) shogo = "Áß∞Âè∑Ôºö‚ö°Ô∏è ÂÖâÈÄü„ÅÆÈÄ≤ÂåñÁ•û";
        else if (diff < 400) shogo = "Áß∞Âè∑Ôºöüî• Âä™Âäõ„ÅÆ„Çø„Ç§„Éî„É≥„Ç∞Áéã";
        if (isRare) shogo = "üëë Ë∂Ö„É¨„Ç¢„ÅÆ‰∏ªÔºÅ " + shogo;
        document.getElementById('res-shogo').innerText = shogo;
        document.getElementById('play-screen').style.display = 'none';
        document.getElementById('final-screen').style.display = 'block';
        const container = document.getElementById('final-monster-container');
        container.innerHTML = "";
        const mClone = monster.cloneNode(true);
        const sClone = shadow.cloneNode(true);
        container.appendChild(mClone);
        container.appendChild(sClone);
        saveToCollection(monsterName, monster.className, monster.style.backgroundColor, isRare);
    }

    function saveToCollection(name, className, bgColor, rare) {
        const collection = JSON.parse(localStorage.getItem('monsterCollection') || '[]');
        collection.push({ name, className, bgColor, rare });
        localStorage.setItem('monsterCollection', JSON.stringify(collection));
        loadCollection();
    }

    function loadCollection() {
        const grid = document.getElementById('collection-grid');
        grid.innerHTML = "";
        const collection = JSON.parse(localStorage.getItem('monsterCollection') || '[]');
        const count = collection.length;
        const badgeEl = document.getElementById('reward-badge');
        const progressEl = document.getElementById('reward-progress');

        if (count >= 10) { badgeEl.innerHTML = "Áß∞Âè∑Ôºöüëë ‰ºùË™¨„ÅÆ„Ç¥„ÉÉ„Éâ„Éñ„É™„Éº„ÉÄ„Éº"; progressEl.innerText = "„Ç≥„É≥„Éó„É™„Éº„Éà„Å†„Å£„Å¥ÔºÅ"; }
        else if (count >= 5) { badgeEl.innerHTML = "Áß∞Âè∑Ôºöüåü ‰∏ÄÊµÅ„Éñ„É™„Éº„ÉÄ„Éº„Å†„Çè„Äú„Çì"; progressEl.innerText = `„ÅÇ„Å® ${10-count} Âåπ„Åß‰ºùË™¨„Å†„Å£„Å¥ÔºÅ`; }
        else if (count >= 3) { badgeEl.innerHTML = "Áß∞Âè∑Ôºöüí™ ÊúüÂæÖ„ÅÆ„Éñ„É™„Éº„ÉÄ„Éº"; progressEl.innerText = `„ÅÇ„Å® ${5-count} Âåπ„Åß‰∏ÄÊµÅ„Å†„Å£„Å¥ÔºÅ`; }
        else { badgeEl.innerHTML = "Áß∞Âè∑Ôºöü•ö „Åü„Åæ„Åî„Éñ„É™„Éº„ÉÄ„Éº"; progressEl.innerText = `„ÅÇ„Å® ${3-count} Âåπ„ÅßÊúüÂæÖ„ÅÆÊòü„Å†„Å£„Å¥ÔºÅ`; }

        collection.forEach(m => {
            const item = document.createElement('div');
            item.className = 'mini-monster';
            const rareClass = m.rare ? "rare-effect" : "";
            const rareBadge = m.rare ? '<div class="rare-badge">ULTRA</div>' : '';
            item.innerHTML = `
                ${rareBadge}
                <div class="mini-shape">
                    <div class="${m.className} ${rareClass}" style="background-color:${m.bgColor}; width:40px; height:100px; border-radius:10px; position:relative;">
                        <div class="eye eye-l"></div><div class="eye eye-r"></div><div class="mouth"></div>
                    </div>
                </div>
                <div style="margin-top:25px;"><b>${m.name}</b></div>
            `;
            grid.appendChild(item);
        });
    }

    function clearCollection() {
        if(confirm("„Åö„Åã„Çì„ÇíÁ©∫„Å£„ÅΩ„Å´„Åô„Çã„Å£„Å¥Ôºü")) {
            localStorage.removeItem('monsterCollection');
            loadCollection();
        }
    }

    document.getElementById('go-stage3-btn').onclick = () => {
        monsterName = document.getElementById('m-name').value || "ÂêçÁÑ°„Åó„ÅÆ„É¢„É≥„Çπ„Çø„Éº";
        document.getElementById('name-form').style.display = 'none';
        document.getElementById('play-screen').style.display = 'block';
        stage = 3; stageCount = 0;
        playEvolutionEffect("TRAINING!!", 3);
    };

    window.onload = () => {
        loadCollection();
        nextStep();
        setTimeout(() => { storyOverlay.classList.add('hidden'); }, 5000);
    };
</script>
</body>
</html