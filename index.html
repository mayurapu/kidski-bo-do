<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ¯éŸ³ï¼†ãƒ­ãƒ¼ãƒå­—ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
            background-color: #fff0f5;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; overflow-y: auto;
        }
        #game-container {
            text-align: center; background: white; padding: 30px;
            border-radius: 30px; box-shadow: 0 15px 40px rgba(255, 105, 180, 0.3);
            width: 700px; position: relative; margin-bottom: 40px;
        }
        #speech-bubble { font-size: 1.4em; font-weight: bold; color: #ff1493; height: 1.5em; margin-bottom: 10px; }

        #monster-area {
            height: 220px; display: flex; justify-content: center; align-items: center;
            margin-bottom: 10px; position: relative;
        }

        /* --- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®åŸºæœ¬ --- */
        #monster {
            width: 40px; height: 100px; background-color: #ddd;
            transition: all 0.3s ease-in-out;
            border-radius: 10px; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .eye { position: absolute; top: 25%; width: 10px; height: 10px; background: #333; border-radius: 50%; }
        .eye-l { left: 20%; } .eye-r { right: 20%; }
        .mouth { position: absolute; bottom: 20%; width: 20px; height: 10px; border-bottom: 3px solid #333; border-radius: 0 0 10px 10px; }

        /* ãƒ‘ãƒ¼ãƒ„å¤‰åŒ– */
        .eye-closed { height: 2px !important; border-radius: 0 !important; }
        .eye-big { width: 15px !important; height: 15px !important; }
        .mouth-open { height: 15px !important; background: #333 !important; border-radius: 50% !important; }
        .mouth-flat { border-bottom: 3px solid #333 !important; border-radius: 0 !important; height: 0 !important; }

        /* é€²åŒ–ã®å½¢ */
        .lv0 { width: 30px !important; height: 100px !important; }
        .lv1 { width: 80px !important; height: 80px !important; border-radius: 50% !important; }
        .lv2 { width: 80px !important; height: 80px !important; transform: skew(15deg); border-radius: 5px !important; }
        .lv3 { width: 100px !important; height: 100px !important; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); border-radius: 0 !important; }
        .lv4 { width: 150px !important; height: 80px !important; border-radius: 20px !important; }
        .lv5 { width: 120px !important; height: 120px !important; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }
        .lv6 { width: 100px !important; height: 100px !important; transform: rotate(45deg); border-radius: 0 !important; }
        .lv7 { width: 120px !important; height: 120px !important; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .lv8 { border: 8px double #ff1493 !important; width: 140px !important; height: 140px !important; border-radius: 30% !important; }
        .lv9 { width: 150px !important; height: 150px !important; box-shadow: 0 0 40px #ff69b4; border-radius: 50% !important; }
        .lv10 { animation: grow 1s infinite alternate; filter: hue-rotate(10deg); border-radius: 20px !important; }
        .legendary { box-shadow: 0 0 60px #ffd700 !important; border: 10px gold double !important; transform: scale(1.1) !important; }

        /* ãƒ¬ã‚¢ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å°‚ç”¨ï¼šè™¹è‰²ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .rare-effect {
            animation: rainbow 2s linear infinite !important;
            box-shadow: 0 0 30px #fff, 0 0 50px #ff00de !important;
        }
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        @keyframes grow { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* è¡¨ç¤ºé–¢ä¿‚ */
        #target-display { font-size: 60px; color: #ffb6c1; font-weight: bold; line-height: 1.2; height: 120px; }
        #target-kana { font-size: 30px; color: #ff69b4; }
        .next-key { color: #ff1493; transform: scale(1.1); display: inline-block; }
        .done-key { color: #eee; }

        /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ */
        #keyboard { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 15px; }
        .row { display: flex; gap: 5px; }
        .key { width: 45px; height: 45px; border: 2px solid #ffecf0; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; background: #fafafa; color: transparent; }
        .key.visible { color: #ffc0cb; }
        .key.target-hint { border-color: #ff69b4; color: #ff69b4; background-color: #fff0f5; }

        /* å…¥åŠ›ã¨çµæœ */
        #name-form, #final-screen { display: none; }
        input { width: 80%; margin: 5px; padding: 10px; border: 2px solid #ffb6c1; border-radius: 10px; font-size: 14px; }
        button { background: #ff69b4; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        .result-box { background: #fffaf0; border: 3px solid #ffb6c1; border-radius: 20px; padding: 20px; margin-top: 10px; text-align: left; }
        .res-item { color: #ff1493; font-weight: bold; font-size: 0.9em; margin-top: 8px; }
        .res-val { color: #333; border-bottom: 1px dashed #ffb6c1; padding-bottom: 2px; font-size: 1.1em; margin-bottom: 5px; }

        /* å›³é‘‘ãƒªã‚¹ãƒˆ */
        #collection-container { width: 700px; background: white; border-radius: 30px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; margin-top: 15px; }
        .mini-monster { 
            border: 2px solid #ffecf0; border-radius: 15px; padding: 10px; text-align: center; font-size: 10px; background: #fffafb;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .mini-shape { transform: scale(0.4); margin: -20px 0; }
        .rare-badge { position: absolute; top: 5px; right: 5px; background: linear-gradient(45deg, gold, orange); color: white; font-size: 8px; padding: 2px 5px; border-radius: 10px; font-weight: bold; }

        /* ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¡¨ç¤º */
        #story-overlay {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 15px 25px; border-radius: 20px;
            box-shadow: 0 5px 20px rgba(255, 105, 180, 0.2);
            font-size: 1.1em; color: #ff1493; font-weight: bold; line-height: 1.6;
            text-align: center; max-width: 600px; z-index: 1000;
            opacity: 1; transition: opacity 1s ease-out;
            border: 2px solid #ffb6c1;
        }
        #story-overlay.hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="story-overlay">
    ãŠè…¹ãºã“ãºã“ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒã„ã¾ã™ã€‚<br>
    ã¾ã ã‚ã‹ã¡ã‚ƒã‚“ã ã‹ã‚‰æ¯éŸ³ï¼ˆAIUEOï¼‰ã—ã‹é£Ÿã¹ã‚‰ã‚Œãªã„ã¿ãŸã„ã€‚<br>
    æ¯éŸ³ã‚’ã‚ã’ã¦ã€å¤§ããè‚²ã¦ã¦ã‚ã’ã¦ã­ï¼
</div>

<div id="game-container">
    <div id="play-screen">
        <div id="speech-bubble">ã¯ã˜ã¾ã‚‹ã£ã´ï¼</div>
        <div id="monster-area">
            <div id="monster" class="lv0">
                <div class="eye eye-l"></div><div class="eye eye-r"></div>
                <div class="mouth"></div>
            </div>
        </div>
        <div id="target-display">
            <div id="target-letters"></div>
            <div id="target-kana"></div>
        </div>
        <div id="score-board" style="color:#ff69b4; font-weight:bold; margin: 10px 0;"></div>
        <div id="keyboard">
            <div class="row" id="row1"></div><div class="row" id="row2"></div><div class="row" id="row3"></div>
        </div>
    </div>

    <div id="name-form">
        <div id="form-monster-container" style="height:150px; display:flex; justify-content:center; align-items:center;"></div>
        <h2 id="name-form-title" style="color: #ff1493;">âœ¨ ã—ã‚“ã‹ ãŠã‚ã§ã¨ã†ï¼</h2>
        <input type="text" id="m-name" placeholder="ãªã¾ãˆã‚’ ã¤ã‘ã¦ã­"><br>
        <input type="text" id="m-prof" placeholder="ã©ã‚“ãª ã›ã„ã‹ãã‹ãªï¼Ÿ"><br>
        <input type="text" id="m-skill" placeholder="ã©ã‚“ãª ã®ã†ã‚Šã‚‡ããŒ ã‚ã‚‹ã‹ãªï¼Ÿ"><br>
        <button id="go-stage3-btn">ãªã¾ãˆã‚’æ±ºå®šã—ã¦ ä¿®è¡Œã«ã„ãï¼</button>
    </div>

    <div id="final-screen">
        <h2 id="res-shogo" style="color: #ff1493; margin: 0;"></h2>
        <div id="final-monster-container" style="height:150px; display:flex; justify-content:center; align-items:center;"></div>
        <div class="result-box">
            <div class="res-item">ã€ãªã¾ãˆã€‘</div><div id="res-name" class="res-val"></div>
            <div class="res-item">ã€ã›ã„ã‹ãã€‘</div><div id="res-prof" class="res-val"></div>
            <div class="res-item">ã€ã®ã†ã‚Šã‚‡ãã€‘</div><div id="res-skill" class="res-val"></div>
            <div class="res-item">ğŸ•’ ã€ãã ã¦ãŸæ™‚é–“ã€‘</div><div id="res-time" class="res-val"></div>
        </div>
        <button onclick="location.reload()">ã‚‚ã†ã„ã£ã‹ã„ ãã ã¦ã‚‹</button>
    </div>
</div>

<div id="collection-container">
    <h3 style="color: #ff69b4; margin-top: 0;">ğŸ’– æ­´ä»£ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãšã‹ã‚“</h3>
    <div id="collection-grid" class="collection-grid"></div>
    <button onclick="clearCollection()" style="background: #ccc; font-size: 10px; padding: 5px 10px; margin-top: 20px; border-radius: 10px;">ãšã‹ã‚“ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    const monster = document.getElementById('monster');
    const eyeL = document.querySelector('.eye-l');
    const eyeR = document.querySelector('.eye-r');
    const mouth = document.querySelector('.mouth');
    const speech = document.getElementById('speech-bubble');
    const scoreBoard = document.getElementById('score-board');
    const targetLettersEl = document.getElementById('target-letters');
    const targetKanaEl = document.getElementById('target-kana');
    const storyOverlay = document.getElementById('story-overlay');

    const vowels = { 'A':'ã‚','I':'ã„','U':'ã†','E':'ãˆ','O':'ãŠ' };
    const romaTable = { 'KA':'ã‹','KI':'ã','KU':'ã','KE':'ã‘','KO':'ã“','SA':'ã•','SI':'ã—','SU':'ã™','SE':'ã›','SO':'ã','TA':'ãŸ','TI':'ã¡','TU':'ã¤','TE':'ã¦','TO':'ã¨','NA':'ãª','NI':'ã«','NU':'ã¬','NE':'ã­','NO':'ã®','HA':'ã¯','HI':'ã²','HU':'ãµ','HE':'ã¸','HO':'ã»','MA':'ã¾','MI':'ã¿','MU':'ã‚€','ME':'ã‚','MO':'ã‚‚','RA':'ã‚‰','RI':'ã‚Š','RU':'ã‚‹','RE':'ã‚Œ','RO':'ã‚','WA':'ã‚','WO':'ã‚’','NN':'ã‚“' };
    
    // ç¬¬3ã‚¹ãƒ†ãƒ¼ã‚¸ç”¨ã®å˜èªãƒªã‚¹ãƒˆï¼ˆ30å€‹ã«å¢—ã‚„ã—ãŸã‚ˆï¼ï¼‰
    const wordList = [
        {k:"ã‚Šã‚“ã”",r:"RINNGO"},{k:"ã­ã“",r:"NEKO"},{k:"ã†ã¿",r:"UMI"},{k:"ã»ã—",r:"HOSI"},
        {k:"ã¯ãª",r:"HANA"},{k:"ã™ã„ã‹",r:"SUIKA"},{k:"ãã‚‹ã¾",r:"KURUMA"},{k:"ã¨ã¾ã¨",r:"TOMATO"},
        {k:"ã²ã‹ã‚Š",r:"HIKARI"},{k:"ã¾ã‚“ãŒ",r:"MANNGA"}, // â† MANNGAã«ä¿®æ­£
        {k:"ã„ã¡ã”",r:"ITIGO"},{k:"ãˆã‚“ã´ã¤",r:"ENNPITU"},{k:"ãŠã‹ã—",r:"OKASI"},{k:"ãã‚‚ã®",r:"KIMONO"},
        {k:"ãã˜ã‚‰",r:"KUDIRA"},{k:"ã‘ã‚€ã‚Š",r:"KEMURI"},{k:"ã“ã“ã‚",r:"KOKORO"},{k:"ã•ã‹ãª",r:"SAKANA"},
        {k:"ã—ã‚“ã¶ã‚“",r:"SINNBUNN"},{k:"ã™ãšã‚",r:"SUZUME"},{k:"ã›ã‹ã„",r:"SEKAI"},{k:"ãã‚‰",r:"SORA"},
        {k:"ãŸã¬ã",r:"TANUKI"},{k:"ã¤ããˆ",r:"TUKUE"},{k:"ã¦ãŒã¿",r:"TEGAMI"},{k:"ã¨ã‘ã„",r:"TOKEI"},
        {k:"ãªã¤",r:"NATU"},{k:"ã«ã˜",r:"NIDI"},{k:"ã­ãŒã„",r:"NEGAI"},{k:"ã®ãƒ¼ã¨",r:"NO-TO"}
    ];

    const keys = [['Q','W','E','R','T','Y','U','I','O','P'],['A','S','D','F','G','H','J','K','L'],['Z','X','C','V','B','N','M']];
    const evolutionMessages = ["ãŸã ã®ã¼ã†ã ã£ã´â€¦", "ã¾ã‚‹ããªã£ãŸã£ã´ï¼", "ãŠã—ã‚ƒã‚Œã ã‚ã€œã‚“â™¡", "ã•ã‚“ã‹ãã ã£ã´ï¼", "ã—ã‹ãã ã£ã´ï¼", "ãã‚Šã£ã¨ã—ã¦ããŸã£ã´ï¼", "ã¾ã‚ã£ã¦ã‚‹ã‚ã€œã‚“â™¡", "ãã‚‰ãã‚‰ã ã£ã´ï¼", "ã‚´ãƒ¼ã‚¸ãƒ£ã‚¹ã ã‚ã€œã‚“â™¡", "ã‚‚ã†ã™ãç©¶æ¥µé€²åŒ–ã ã£ã´ï¼", "ã†ã¡ã‚…ã†ã„ã¡ã ã£ã´ãƒ¼ï¼"];

    let totalCount = 0, stageCount = 0, stage = 1, typedIndex = 0;
    let currentTargetRoma = "", currentTargetKana = "";
    let startTime, monsterName = "", speechTimer;
    let isRare = false;

    keys.forEach((row, i) => {
        const rowEl = document.getElementById(`row${i+1}`);
        row.forEach(k => {
            const el = document.createElement('div');
            el.className = 'key' + (vowels[k] ? ' visible' : '');
            el.id = 'key-' + k;
            el.innerText = k;
            rowEl.appendChild(el);
        });
    });

    function randomAppearance() {
        if (stage >= 2 && !isRare && Math.random() < 0.005) {
            isRare = true;
            monster.classList.add('rare-effect');
        }
        const colors = ['#FF69B4', '#FFD700', '#ADFF2F', '#00BFFF', '#BA55D3', '#FF4500', '#00FA9A', '#FFB6C1'];
        monster.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        eyeL.className = 'eye eye-l'; eyeR.className = 'eye eye-r'; mouth.className = 'mouth';
        const eTypes = ['', 'eye-closed', 'eye-big'];
        const eType = eTypes[Math.floor(Math.random() * eTypes.length)];
        if (eType) { eyeL.classList.add(eType); eyeR.classList.add(eType); }
        const mTypes = ['', 'mouth-open', 'mouth-flat'];
        const mType = mTypes[Math.floor(Math.random() * mTypes.length)];
        if (mType) mouth.classList.add(mType);

        if (stage === 1) {
            const lv = Math.floor(totalCount / 10);
            monster.className = 'lv' + (lv > 10 ? 10 : lv);
            speech.innerText = evolutionMessages[lv > 10 ? 10 : lv];
        } else if (stage === 2) {
            monster.className = 'lv' + Math.floor(Math.random() * 11);
            if (isRare) {
                monster.classList.add('rare-effect');
                speech.innerText = "ã™ã”ã™ãã ã‚ã€œã‚“ğŸ’•è¶…ãƒ¬ã‚¢ã ã£ã´ï¼";
            } else {
                speech.innerText = "ã‚‚ã£ã¨ï¼ã‚‚ã£ã¨ãŸã¹ã‚‹ã£ã´ï¼";
            }
        } else {
            monster.className = 'lv' + Math.floor(Math.random() * 11);
            monster.classList.add('legendary');
            if (isRare) monster.classList.add('rare-effect');
            speech.innerText = monsterName + "ã® ä¿®è¡Œã ã£ã´ï¼";
        }
    }

    function nextStep() {
        typedIndex = 0;
        if (stage === 1) {
            currentTargetRoma = Object.keys(vowels)[Math.floor(Math.random() * 5)];
            currentTargetKana = vowels[currentTargetRoma];
            scoreBoard.innerHTML = `ãŸã¹ãŸã‹ãš: <span id="count">${totalCount}</span> / 100`;
        } else if (stage === 2) {
            const romaKeys = Object.keys(romaTable);
            currentTargetRoma = romaKeys[Math.floor(Math.random() * romaKeys.length)];
            currentTargetKana = romaTable[currentTargetRoma];
            scoreBoard.innerHTML = `ç¬¬ï¼’ã‚¹ãƒ†ãƒ¼ã‚¸ï¼: <span id="count">${stageCount}</span> / 85`;
        } else {
            const word = wordList[Math.floor(Math.random() * wordList.length)];
            currentTargetRoma = word.r;
            currentTargetKana = word.k;
            scoreBoard.innerHTML = `æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šä¿®è¡Œ: <span id="count">${stageCount}</span> / 10`;
        }
        renderTarget();
    }

    function renderTarget() {
        targetLettersEl.innerHTML = "";
        for (let i = 0; i < currentTargetRoma.length; i++) {
            const span = document.createElement('span');
            span.innerText = currentTargetRoma[i];
            span.className = (i < typedIndex ? 'done-key' : (i === typedIndex ? 'next-key' : ''));
            targetLettersEl.appendChild(span);
        }
        targetKanaEl.innerText = `ï¼ˆ${currentTargetKana}ï¼‰`;
        document.querySelectorAll('.key').forEach(k => k.classList.remove('target-hint'));
        document.getElementById('key-' + currentTargetRoma[typedIndex])?.classList.add('target-hint');
    }

    window.addEventListener('keydown', (e) => {
        if (!storyOverlay.classList.contains('hidden')) {
            storyOverlay.classList.add('hidden');
        }
        if (document.getElementById('name-form').style.display === 'block' || document.getElementById('final-screen').style.display === 'block') return;
        if (!startTime) startTime = new Date();

        const key = e.key.toUpperCase();
        if (key === currentTargetRoma[typedIndex]) {
            clearTimeout(speechTimer);
            typedIndex++;
            if (typedIndex >= currentTargetRoma.length) {
                if (stage === 3) { stageCount++; speech.innerText = `ã€Œ${currentTargetKana}ï¼ã€`; }
                else { totalCount++; stageCount++; speech.innerText = "ãƒ‘ã‚¯ãƒƒï¼"; }
                randomAppearance();
                if (stage === 1 && totalCount >= 100) {
                    stage = 2; stageCount = 0;
                    document.querySelectorAll('.key').forEach(k => k.classList.add('visible'));
                    speech.innerText = "ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã—ãŸã£ã´ï¼ï¼";
                    setTimeout(nextStep, 1000);
                } else if (stage === 2 && stageCount >= 85) { showNameForm(); }
                else if (stage === 3 && stageCount >= 10) { showFinalScreen(); }
                else { setTimeout(nextStep, 200); }
            } else { renderTarget(); }
        } else if (key.length === 1 && /^[A-Z]$/.test(key)) {
            clearTimeout(speechTimer); speech.innerText = "ã«ãŒãƒ¼ã„ï¼ã ã£ã´ï¼";
            speechTimer = setTimeout(() => { randomAppearance(); }, 800);
        }
    });

    function showNameForm() {
        document.getElementById('play-screen').style.display = 'none';
        document.getElementById('name-form').style.display = 'block';
        if (isRare) document.getElementById('name-form-title').innerText = "âœ¨ è¶…ãƒ»æ¿€ãƒ¬ã‚¢ã—ã‚“ã‹ ãŠã‚ã§ã¨ã†ï¼ âœ¨";
        document.getElementById('form-monster-container').innerHTML = "";
        document.getElementById('form-monster-container').appendChild(monster.cloneNode(true));
    }

    function showFinalScreen() {
        const diff = (new Date() - startTime) / 1000;
        const prof = document.getElementById('m-prof').value || "ãµã‚ã„";
        const skill = document.getElementById('m-skill').value || "ãªã—";
        const timeStr = `${Math.floor(diff/60)}åˆ† ${(diff%60).toFixed(1)}ç§’`;
        document.getElementById('res-name').innerText = monsterName + (isRare ? "ï¼ˆè¶…ãƒ¬ã‚¢ï¼‰" : "");
        document.getElementById('res-prof').innerText = prof;
        document.getElementById('res-skill').innerText = skill;
        document.getElementById('res-time').innerText = timeStr;
        let shogo = "ç§°å·ï¼šâ˜˜ï¸ ã®ã‚“ã³ã‚Šè‚²æˆåäºº";
        if (diff < 150) shogo = "ç§°å·ï¼šâš¡ï¸ å…‰é€Ÿã®é€²åŒ–ç¥";
        else if (diff < 300) shogo = "ç§°å·ï¼šğŸ”¥ åŠªåŠ›ã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç‹";
        if (isRare) shogo = "ğŸ‘‘ è¶…ãƒ¬ã‚¢ã®ä¸»ï¼ " + shogo;
        document.getElementById('res-shogo').innerText = shogo;
        document.getElementById('play-screen').style.display = 'none';
        document.getElementById('final-screen').style.display = 'block';
        document.getElementById('final-monster-container').innerHTML = "";
        document.getElementById('final-monster-container').appendChild(monster.cloneNode(true));
        saveToCollection(monsterName, monster.className, monster.style.backgroundColor, isRare);
    }

    function saveToCollection(name, className, bgColor, rare) {
        const collection = JSON.parse(localStorage.getItem('monsterCollection') || '[]');
        collection.push({ name, className, bgColor, rare });
        localStorage.setItem('monsterCollection', JSON.stringify(collection));
        loadCollection();
    }

    function loadCollection() {
        const grid = document.getElementById('collection-grid');
        grid.innerHTML = "";
        const collection = JSON.parse(localStorage.getItem('monsterCollection') || '[]');
        collection.forEach(m => {
            const item = document.createElement('div');
            item.className = 'mini-monster';
            const rareClass = m.rare ? "rare-effect" : "";
            const rareBadge = m.rare ? '<div class="rare-badge">ULTRA</div>' : '';
            item.innerHTML = `
                ${rareBadge}
                <div class="mini-shape"><div class="${m.className} ${rareClass}" style="background-color:${m.bgColor}; width:40px; height:100px; border-radius:10px; position:relative;">
                    <div class="eye eye-l"></div><div class="eye eye-r"></div><div class="mouth"></div>
                </div></div>
                <div style="margin-top:25px;"><b>${m.name}</b></div>
            `;
            grid.appendChild(item);
        });
    }

    function clearCollection() {
        if(confirm("ãšã‹ã‚“ã‚’ç©ºã£ã½ã«ã™ã‚‹ã£ã´ï¼Ÿ")) {
            localStorage.removeItem('monsterCollection');
            loadCollection();
        }
    }

    document.getElementById('go-stage3-btn').onclick = () => {
        monsterName = document.getElementById('m-name').value || "åç„¡ã—ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼";
        document.getElementById('name-form').style.display = 'none';
        document.getElementById('play-screen').style.display = 'block';
        stage = 3; stageCount = 0;
        randomAppearance();
        nextStep();
    };

    window.onload = () => {
        loadCollection();
        nextStep();
        setTimeout(() => { storyOverlay.classList.add('hidden'); }, 5000);
    };
</script>
</body>
</html>