

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãŠã—ã‚ƒã¹ã‚Šï¼æ¯éŸ³ï¼†ãƒ­ãƒ¼ãƒå­—ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; overflow-y: auto;
            transition: background-color 1s ease;
            position: relative;
        }

        #game-container {
            text-align: center; background: white; padding: 30px;
            border-radius: 30px; box-shadow: 0 15px 40px rgba(255, 105, 180, 0.3);
            width: 700px; position: relative; margin-bottom: 40px;
        }

        /* ã‚³ãƒ³ãƒœè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #combo-display {
            position: absolute; top: -10px; right: 20px;
            font-size: 32px; font-weight: bold; color: #ff1493;
            text-shadow: 2px 2px 0 white; opacity: 0;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; z-index: 15;
        }
        .combo-active { opacity: 1 !important; transform: scale(1.2) rotate(10deg); }

        #speech-bubble { font-size: 1.4em; font-weight: bold; color: #ff1493; height: 1.5em; margin-bottom: 10px; }

        #monster-area {
            height: 220px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-bottom: 10px; position: relative;
        }

        #evolution-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; border-radius: 30px; opacity: 0; pointer-events: none;
            z-index: 10;
        }
        .flash-active { animation: flash-anim 0.8s ease-out; }
        @keyframes flash-anim {
            0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; }
        }

        #evolution-banner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 80px; font-weight: bold; color: #ff1493; text-shadow: 3px 3px 0 white;
            white-space: nowrap; opacity: 0; pointer-events: none; z-index: 11;
        }
        .banner-active { animation: banner-anim 1.5s ease-in-out; }
        @keyframes banner-anim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        #monster {
            width: 40px; height: 100px; background-color: #ddd;
            transition: all 0.3s ease-in-out;
            border-radius: 10px; position: relative;
            display: flex; justify-content: center; align-items: center;
            z-index: 2;
        }
        #monster-shadow {
            width: 50px; height: 10px; background: rgba(0,0,0,0.1);
            border-radius: 50%; margin-top: 15px;
            transition: all 0.3s ease-in-out;
            filter: blur(2px);
        }

        .eye { position: absolute; top: 25%; width: 10px; height: 10px; background: #333; border-radius: 50%; }
        .eye-l { left: 20%; } .eye-r { right: 20%; }
        .mouth { position: absolute; bottom: 20%; width: 20px; height: 10px; border-bottom: 3px solid #333; border-radius: 0 0 10px 10px; }

        .eye-closed { height: 2px !important; border-radius: 0 !important; }
        .eye-big { width: 15px !important; height: 15px !important; }
        .mouth-open { height: 15px !important; background: #333 !important; border-radius: 50% !important; }
        .mouth-flat { border-bottom: 3px solid #333 !important; border-radius: 0 !important; height: 0 !important; }
 /* --- è¿½åŠ ãƒ‘ãƒ¼ãƒ„ã®ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        /* è…•ã®åŸºæœ¬ */
        .arm {
            position: absolute; width: 25px; height: 10px;
            background-color: inherit; /* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¨åŒã˜è‰²ã«ã™ã‚‹ */
            border: 2px solid rgba(0,0,0,0.1); border-radius: 5px;
            top: 50%; z-index: -1;
        }
        .arm-l { left: -20px; transform: rotate(-20deg); }
        .arm-r { right: -20px; transform: rotate(20deg); }

        /* ç¾½ã®åŸºæœ¬ */
        .wing {
            position: absolute; width: 40px; height: 30px;
            background-color: #fff; opacity: 0.7;
            border-radius: 50% 50% 0 50%; top: 20%; z-index: -2;
        }
        .wing-l { left: -35px; transform: rotate(-30deg); }
        .wing-r { right: -35px; transform: rotate(30deg); border-radius: 50% 50% 50% 0; }
        /* ----------------------- */
        /* é€²åŒ–ã‚¯ãƒ©ã‚¹ï¼ˆãã®ã¾ã¾ï¼‰ */
        .lv0 { width: 30px !important; height: 100px !important; }
        .lv1 { width: 80px !important; height: 80px !important; border-radius: 50% !important; }
        .lv2 { width: 80px !important; height: 80px !important; transform: skew(15deg); border-radius: 5px !important; }
        .lv3 { width: 100px !important; height: 100px !important; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); border-radius: 0 !important; }
        .lv4 { width: 150px !important; height: 80px !important; border-radius: 20px !important; }
        .lv5 { width: 120px !important; height: 120px !important; clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); }
        .lv6 { width: 100px !important; height: 100px !important; transform: rotate(45deg); border-radius: 0 !important; }
        .lv7 { width: 120px !important; height: 120px !important; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .lv8 { border: 8px double #ff1493 !important; width: 140px !important; height: 140px !important; border-radius: 30% !important; }
        .lv9 { width: 150px !important; height: 150px !important; box-shadow: 0 0 40px #ff69b4; border-radius: 50% !important; }
        .lv10 { animation: grow 1s infinite alternate; filter: hue-rotate(10deg); border-radius: 20px !important; }
        .legendary { box-shadow: 0 0 60px #ffd700 !important; border: 10px gold double !important; transform: scale(1.1) !important; }

        .rare-effect {
            animation: rainbow 2s linear infinite !important;
            box-shadow: 0 0 30px #fff, 0 0 50px #ff00de !important;
        }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        @keyframes grow { from { transform: scale(1); } to { transform: scale(1.1); } }

        #target-display { font-size: 60px; color: #ffb6c1; font-weight: bold; line-height: 1.2; height: 120px; }
        #target-kana { font-size: 30px; color: #ff69b4; }
        .next-key { color: #ff1493; transform: scale(1.1); display: inline-block; }
        .done-key { color: #eee; }

        #keyboard { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 15px; }
        .row { display: flex; gap: 5px; }
        .key { width: 45px; height: 45px; border: 2px solid #ffecf0; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; background: #fafafa; color: transparent; }
        .key.visible { color: #ffc0cb; }
        .key.target-hint { border-color: #ff69b4; color: #ff69b4; background-color: #fff0f5; }
        /* æ­£è§£ã—ãŸæ™‚ã«ä¸€ç¬ã¤ã‘ã‚‹ã‚¯ãƒ©ã‚¹ */
        .key.press-correct {
            background-color: #ff69b4 !important; /* ãƒ”ãƒ³ã‚¯è‰²ã«å…‰ã‚‹ */
            color: white !important;
            transform: translateY(4px); /* å°‘ã—æ²ˆã‚€ */
            transition: none; /* æŠ¼ã—ãŸç¬é–“ã¯ãƒ‘ãƒƒã¨å¤‰ãˆã‚‹ */
            box-shadow: none; /* å½±ã‚’æ¶ˆã—ã¦æŠ¼ã—è¾¼ã‚“ã æ„Ÿã‚’å‡ºã™ */}
        #name-form, #final-screen { display: none; }
        input { width: 80%; margin: 5px; padding: 10px; border: 2px solid #ffb6c1; border-radius: 10px; font-size: 14px; }
        button { background: #ff69b4; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        .result-box { background: #fffaf0; border: 3px solid #ffb6c1; border-radius: 20px; padding: 20px; margin-top: 10px; text-align: left; }
        .res-item { color: #ff1493; font-weight: bold; font-size: 0.9em; margin-top: 8px; }
        .res-val { color: #333; border-bottom: 1px dashed #ffb6c1; padding-bottom: 2px; font-size: 1.1em; margin-bottom: 5px; }

        #collection-container { width: 700px; background: white; border-radius: 30px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; margin-top: 15px; }
        .mini-monster { 
            border: 2px solid #ffecf0; border-radius: 15px; padding: 10px; text-align: center; font-size: 10px; background: #fffafb;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .mini-shape { transform: scale(0.4); margin: -20px 0; }
        .rare-badge { position: absolute; top: 5px; right: 5px; background: linear-gradient(45deg, gold, orange); color: white; font-size: 8px; padding: 2px 5px; border-radius: 10px; font-weight: bold; }

        #reward-area { background: #fff0f5; border: 2px dashed #ff69b4; border-radius: 20px; padding: 15px; margin-bottom: 20px; text-align: center; }
        .reward-badge { font-size: 1.2em; font-weight: bold; color: #ff1493; margin-bottom: 5px; }
        .reward-progress { color: #666; font-size: 0.9em; }

        #story-overlay {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 15px 25px; border-radius: 20px;
            box-shadow: 0 5px 20px rgba(255, 105, 180, 0.2);
            font-size: 1.1em; color: #ff1493; font-weight: bold; line-height: 1.6;
            text-align: center; max-width: 600px; z-index: 1000;
            opacity: 1; transition: opacity 1s ease-out;
            border: 2px solid #ffb6c1;
        }
        #story-overlay.hidden { opacity: 0; pointer-events: none; }
        
        /* ãƒãƒ¼ãƒŸã‚¹é™å®šï¼šç¥ã€…ã—ã„ã‚ªãƒ¼ãƒ© */
        .god-ray {
            box-shadow: 0 0 80px #fff, 0 0 100px #ffd700, 0 0 120px #ff00de !important;
            animation: god-shine 2s infinite alternate !important;
            border: 5px solid #fff !important;
        }
        @keyframes god-shine {
            from { filter: brightness(1) contrast(1.2) drop-shadow(0 0 10px gold); }
            to { filter: brightness(1.5) contrast(1.5) drop-shadow(0 0 30px white); }
        }

/* --- èƒŒæ™¯ãƒ‡ã‚¶ã‚¤ãƒ³ã®å®šç¾© --- */
        /* ãƒ¬ãƒ™ãƒ«1ï¼šè‰åŸ */
        body.stage1-bg {
            background: linear-gradient(#87CEEB 60%, #32CD32 60%);
        }
        body.stage1-bg::before { content: "â˜˜ï¸ ğŸŒ· â˜˜ï¸ â˜˜ï¸ ğŸŒ·"; position: absolute; bottom: 10%; font-size: 30px; opacity: 0.5; letter-spacing: 50px; }

        /* ãƒ¬ãƒ™ãƒ«2ï¼šç”º */
        body.stage2-bg {
            background: linear-gradient(#FF8C00 50%, #808080 50%);
        }
        body.stage2-bg::before { content: "ğŸ˜ï¸ ğŸ¢ ğŸ  ğŸ˜ï¸ ğŸ¢"; position: absolute; bottom: 42%; font-size: 40px; opacity: 0.7; letter-spacing: 30px; }

        /* ãƒ¬ãƒ™ãƒ«3ï¼šãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ */
        body.stage3-bg {
            background: radial-gradient(circle, #4b4b4b, #000000);
        }
        body.stage3-bg::before { content: "ğŸ”¥ ğŸ’€ ğŸ”¥ ğŸ’€ ğŸ”¥"; position: absolute; top: 20%; font-size: 30px; opacity: 0.4; letter-spacing: 100px; } 
        body.stage4-bg { background: linear-gradient(45deg, #000, #4b0082); color: white; }   
</style>
</head>
<body>

<div id="story-overlay">
    ãŠè…¹ãºã“ãºã“ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒã„ã¾ã™ã€‚<br>
    æ¯éŸ³ã‚’ã‚ã’ã¦ã€ãŸãã•ã‚“ãŠã—ã‚ƒã¹ã‚Šã•ã›ã¦ã‚ã’ã¦ã­ï¼
</div>

<div id="game-container">
    <div id="combo-display">0 COMBO!</div>
    <div id="evolution-flash"></div>
    <div id="evolution-banner">LEVEL UP!</div>

    <div id="play-screen">
        <div id="speech-bubble">ã¯ã˜ã¾ã‚‹ã£ã´ï¼</div>
        <div id="monster-area">
            <div id="monster" class="lv0">
                <div class="eye eye-l"></div><div class="eye eye-r"></div>
                <div class="mouth"></div>
                <div id="arm-l" class="arm arm-l" style="display:none;"></div>
                <div id="arm-r" class="arm arm-r" style="display:none;"></div>
                <div id="wing-l" class="wing wing-l" style="display:none;"></div>
                <div id="wing-r" class="wing wing-r" style="display:none;"></div>
                </div>
            <div id="monster-shadow"></div>
        </div>
        <div id="target-display">
            <div id="target-letters"></div>
            <div id="target-kana"></div>
        </div>
        <div id="score-board" style="color:#ff69b4; font-weight:bold; margin: 10px 0;"></div>
        <div id="keyboard">
            <div class="row" id="row1"></div><div class="row" id="row2"></div><div class="row" id="row3"></div>
        </div>
    </div>

    <div id="name-form">
        <div id="form-monster-container" style="height:180px; display:flex; flex-direction:column; justify-content:center; align-items:center;"></div>
        <h2 id="name-form-title" style="color: #ff1493;">âœ¨ ã—ã‚“ã‹ ãŠã‚ã§ã¨ã†ï¼</h2>
        <input type="text" id="m-name" placeholder="ãªã¾ãˆã‚’ ã¤ã‘ã¦ã­"><br>
        <input type="text" id="m-prof" placeholder="ã©ã‚“ãª ã›ã„ã‹ãã‹ãªï¼Ÿ"><br>
        <input type="text" id="m-skill" placeholder="ã©ã‚“ãª ã®ã†ã‚Šã‚‡ããŒ ã‚ã‚‹ã‹ãªï¼Ÿ"><br>
        <button id="go-stage3-btn">ãªã¾ãˆã‚’æ±ºå®šã—ã¦ ä¿®è¡Œã«ã„ãï¼</button>
    </div>

    <div id="final-screen">
        <h2 id="res-shogo" style="color: #ff1493; margin: 0;"></h2>
        <div id="final-monster-container" style="height:180px; display:flex; flex-direction:column; justify-content:center; align-items:center;"></div>
        <div class="result-box">
            <div class="res-item">ã€ãªã¾ãˆã€‘</div><div id="res-name" class="res-val"></div>
            <div class="res-item">ã€ã›ã„ã‹ãã€‘</div><div id="res-prof" class="res-val"></div>
            <div class="res-item">ã€ã®ã†ã‚Šã‚‡ãã€‘</div><div id="res-skill" class="res-val"></div>
            <div class="res-item">ğŸ•’ ã€ãã ã¦ãŸæ™‚é–“ã€‘</div><div id="res-time" class="res-val"></div>
            <div id="letter-box" style="background: #fff; border: 2px dashed #ff69b4; border-radius: 15px; padding: 15px; margin-top: 15px; color: #ff1493; font-weight: bold; font-style: italic;">
            </div>
        </div>
        <button onclick="location.reload()">ã‚‚ã†ã„ã£ã‹ã„ ãã ã¦ã‚‹</button>
    </div>
</div>

<div id="custom-word-form" style="display: none;">
        <h2 style="color: #ff1493;">ğŸ“ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«è¨€è‘‰ã‚’æ•™ãˆã‚‹</h2>
        <p style="color: #666; font-size: 0.9em;">æ•™ãˆãŸè¨€è‘‰ã¯æ¬¡ã‹ã‚‰ã€Œã‚¹ãƒ†ãƒ¼ã‚¸3ã€ã§å‡ºã‚‹ã‚ˆã†ã«ãªã‚‹ã£ã´ï¼</p>
        <input type="text" id="new-kana" placeholder="æ•™ãˆã‚‹è¨€è‘‰ï¼ˆä¾‹ï¼šãŠã¯ã‚ˆãƒ¼ï¼‰"><br>
        <input type="text" id="new-roma" placeholder="æ‰“ã¡æ–¹ï¼ˆä¾‹ï¼šOHAYO-ï¼‰"><br>
        <button id="save-word-btn">è¨€è‘‰ã‚’ä¿å­˜ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>

<div id="collection-container">
    <h3 style="color: #ff69b4; margin-top: 0;">ğŸ’– æ­´ä»£ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãšã‹ã‚“</h3>
    <div id="reward-area">
        <div id="reward-badge" class="reward-badge">ç§°å·ï¼šãŸã¾ã”ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼ğŸ¥š</div>
        <div id="reward-progress" class="reward-progress">ã‚ã¨ 3åŒ¹ ã§æ–°ã—ã„ã”è¤’ç¾ã ã£ã´ï¼</div>
    </div>
    <div id="collection-grid" class="collection-grid"></div>
    <button onclick="clearCollection()" style="background: #ccc; font-size: 10px; padding: 5px 10px; margin-top: 20px; border-radius: 10px;">ãšã‹ã‚“ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    const monster = document.getElementById('monster');
    const shadow = document.getElementById('monster-shadow');
    const eyeL = document.querySelector('.eye-l');
    const eyeR = document.querySelector('.eye-r');
    const mouth = document.querySelector('.mouth');
    const speech = document.getElementById('speech-bubble');
    const scoreBoard = document.getElementById('score-board');
    const targetLettersEl = document.getElementById('target-letters');
    const targetKanaEl = document.getElementById('target-kana');
    const storyOverlay = document.getElementById('story-overlay');
    const flashEl = document.getElementById('evolution-flash');
    const bannerEl = document.getElementById('evolution-banner');
    const comboDisplay = document.getElementById('combo-display');

    const vowels = { 'A':'ã‚','I':'ã„','U':'ã†','E':'ãˆ','O':'ãŠ' };
    const romaTable = { 
        'KA':'ã‹','KI':'ã','KU':'ã','KE':'ã‘','KO':'ã“',
        'SA':'ã•','SI':'ã—','SU':'ã™','SE':'ã›','SO':'ã',
        'TA':'ãŸ','TI':'ã¡','TU':'ã¤','TE':'ã¦','TO':'ã¨',
        'NA':'ãª','NI':'ã«','NU':'ã¬','NE':'ã­','NO':'ã®',
        'HA':'ã¯','HI':'ã²','HU':'ãµ','HE':'ã¸','HO':'ã»',
        'MA':'ã¾','MI':'ã¿','MU':'ã‚€','ME':'ã‚','MO':'ã‚‚',
        'YA':'ã‚„','YU':'ã‚†','YO':'ã‚ˆ',
        'RA':'ã‚‰','RI':'ã‚Š','RU':'ã‚‹','RE':'ã‚Œ','RO':'ã‚',
        'WA':'ã‚','WO':'ã‚’','NN':'ã‚“' 
    };
    
    const wordList = [
        {k:"ã‚Šã‚“ã”",r:"RINNGO"},{k:"ã­ã“",r:"NEKO"},{k:"ã†ã¿",r:"UMI"},{k:"ã»ã—",r:"HOSI"},
        {k:"ã¯ãª",r:"HANA"},{k:"ã™ã„ã‹",r:"SUIKA"},{k:"ãã‚‹ã¾",r:"KURUMA"},{k:"ã¨ã¾ã¨",r:"TOMATO"},
        {k:"ã„ã¡ã”",r:"ITIGO"},{k:"ã•ã‹ãª",r:"SAKANA"},{k:"ã‚„ã¾",r:"YAMA"},{k:"ã‚†ã",r:"YUKI"}
    ];

    const sentenceList = [
       {k:"ä¼èª¬ã®ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼ã ã£ã´ï¼", r:"DENNSETSU NO BURI-DA- DAPPI!"},
       {k:"ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ç¥æ§˜ã ã­ï¼", r:"TAIPINGU NO KAMISAMA DANE!"},
       {k:"ã“ã‚Œã‹ã‚‰ã‚‚ã‚ˆã‚ã—ãã­ï¼", r:"KOREKARAMO YOROSIKUNE!"}
    ];
    
    // æ–‡å­—ã”ã¨ã®åå¿œãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    const letterReactions = {
        'A': "ã€Œã‚ã€ã¾ã„ã‚‚ã®å¤§å¥½ãã ã£ã´ï¼",
        'I': "ã€Œã„ã€ã¡ã”ã¯ã‚ã¾ã„ã£ã´ï¼",
        'U': "ã€Œã†ã€ã¿ã®å¹¸ãŒé£Ÿã¹ãŸã„ã£ã´ï¼",
        'E': "ã€Œãˆã€ã‚“ã´ã¤ã¯é£Ÿã¹ã¡ã‚ƒãƒ€ãƒ¡ã ã£ã´ï¼",
        'O': "ã€ŒãŠã€ãªã‹ã„ã£ã±ã„ã«ãªã£ã¦ããŸâ™¡",
        'K': "ã€Œã‹ã€ããã‘ã“ï¼ã‹ã£ã“ã„ã„ã£ã´ï¼",
        'S': "ã€Œã•ã€ã‚ã‚„ã‹ã ã£ã´ï¼",
        'N': "ã€Œã‚“ã€ï¼Ÿãªã«ã‹å‘¼ã‚“ã ã£ã´ï¼Ÿ"
    };

    const keys = [['Q','W','E','R','T','Y','U','I','O','P'],['A','S','D','F','G','H','J','K','L'],['Z','X','C','V','B','N','M']];
    const evolutionMessages = ["ãŸã ã®ã¼ã†ã ã£ã´â€¦", "ã¾ã‚‹ããªã£ãŸã£ã´ï¼", "ãŠã—ã‚ƒã‚Œã ã‚ã€œã‚“â™¡", "ã•ã‚“ã‹ãã ã£ã´ï¼", "ã—ã‹ãã ã£ã´ï¼", "ãã‚Šã£ã¨ã—ã¦ããŸã£ã´ï¼", "ã¾ã‚ã£ã¦ã‚‹ã‚ã€œã‚“â™¡", "ãã‚‰ãã‚‰ã ã£ã´ï¼", "ã‚´ãƒ¼ã‚¸ãƒ£ã‚¹ã ã‚ã€œã‚“â™¡", "ã‚‚ã†ã™ãç©¶æ¥µé€²åŒ–ã ã£ã´ï¼", "ã†ã¡ã‚…ã†ã„ã¡ã ã£ã´ãƒ¼ï¼"];

    let totalCount = 0, stageCount = 0, stage = 1, typedIndex = 0, combo = 0;
    let currentTargetRoma = "", currentTargetKana = "";
    let startTime, monsterName = "", speechTimer;
    let isRare = false;
    let missCount = 0; // ãƒŸã‚¹ã—ãŸå›æ•°ã‚’æ•°ãˆã‚‹

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ä½œæˆ
    keys.forEach((row, i) => {
        const rowEl = document.getElementById(`row${i+1}`);
        row.forEach(k => {
            const el = document.createElement('div');
            el.className = 'key' + (vowels[k] ? ' visible' : '');
            el.id = 'key-' + k;
            el.innerText = k;
            rowEl.appendChild(el);
        });
    });

    function randomAppearance() {
        if (stage >= 2 && !isRare && Math.random() < 0.005) {
            isRare = true;
            monster.classList.add('rare-effect');
        }
        const colors = ['#FF69B4', '#FFD700', '#ADFF2F', '#00BFFF', '#BA55D3', '#FF4500', '#00FA9A', '#FFB6C1'];
        monster.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        
        // ãƒ‘ãƒ¼ãƒ„ã®ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º
        const armL = document.getElementById('arm-l');
        const armR = document.getElementById('arm-r');
        const wingL = document.getElementById('wing-l');
        const wingR = document.getElementById('wing-r');

        // ä¸€æ—¦å…¨éƒ¨æ¶ˆã™
        armL.style.display = armR.style.display = wingL.style.display = wingR.style.display = 'none';

        if (stage >= 2) {
            // 50%ã®ç¢ºç‡ã§è…•ãŒç”Ÿãˆã‚‹
            if (Math.random() > 0.5) {
                armL.style.display = armR.style.display = 'block';
            }
            // 30%ã®ç¢ºç‡ã§ç¾½ãŒç”Ÿãˆã‚‹
            if (Math.random() > 0.7) {
                wingL.style.display = wingR.style.display = 'block';
            }
        }

        eyeL.className = 'eye eye-l'; eyeR.className = 'eye eye-r'; mouth.className = 'mouth';
        const eTypes = ['', 'eye-closed', 'eye-big'];
        const eType = eTypes[Math.floor(Math.random() * eTypes.length)];
        if (eType) { eyeL.classList.add(eType); eyeR.classList.add(eType); }
        const mTypes = ['', 'mouth-open', 'mouth-flat'];
        const mType = mTypes[Math.floor(Math.random() * mTypes.length)];
        if (mType) mouth.classList.add(mType);

        shadow.style.width = (monster.offsetWidth + 20) + "px";
    }

    // ãŠã—ã‚ƒã¹ã‚Šãƒ­ã‚¸ãƒƒã‚¯ã®å¼·åŒ–
    function monsterSpeak(type, key = '') {
        clearTimeout(speechTimer);
        let msg = "";

        if (type === 'eat') {
            // æ–‡å­—ã”ã¨ã®åå¿œãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (letterReactions[key]) {
                msg = letterReactions[key];
            } else if (combo >= 10) {
                msg = "ç¥é€Ÿã ã£ã´ï¼ã™ã”ã™ãã‚‹ã£ã´ï¼";
            } else if (combo >= 5) {
                msg = "ãƒãƒªãƒãƒªã ã£ã´ï¼ã‚³ãƒ³ãƒœæœ€é«˜ï¼";
            } else {
                msg = "ãƒ‘ã‚¯ãƒƒï¼ãŠã„ã—ã„ã£ã´ï¼";
            }
        } else if (type === 'miss') {
            msg = "ã«ãŒãƒ¼ã„ï¼ãºã£ãºã£ã ã£ã´ï¼";
        } else if (type === 'evolution') {
            const lv = Math.floor(totalCount / 10);
            msg = evolutionMessages[lv > 10 ? 10 : lv];
        }

        speech.innerText = msg;
    }

   function playEvolutionEffect(message, nextStage) {
        flashEl.classList.add('flash-active');
        bannerEl.innerText = message;
        bannerEl.classList.add('banner-active');
        
        setTimeout(() => {
            flashEl.classList.remove('flash-active');
            bannerEl.classList.remove('banner-active');
            
            // --- ã“ã“ã§èƒŒæ™¯ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ ---
            if (nextStage === 2) {
                document.body.className = 'stage2-bg'; // ã‚¹ãƒ†ãƒ¼ã‚¸2ã®èƒŒæ™¯ã¸ï¼
            } else if (nextStage === 3) {
                document.body.className = 'stage3-bg'; // ã‚¹ãƒ†ãƒ¼ã‚¸3ã®èƒŒæ™¯ã¸ï¼
            } else if (nextStage === 4) {
            document.body.className = 'stage3-bg'; // éš ã—ã¯ã¨ã‚Šã‚ãˆãš3ã¨åŒã˜
            }
            
            nextStep();
        }, 1500);
    }

    function nextStep() {
        typedIndex = 0;
        if (stage === 1) {
            currentTargetRoma = Object.keys(vowels)[Math.floor(Math.random() * 5)];
            currentTargetKana = vowels[currentTargetRoma];
            scoreBoard.innerHTML = `ãŸã¹ãŸã‹ãš: <span id="count">${totalCount}</span> / 50`;
        } else if (stage === 2) {
            const romaKeys = Object.keys(romaTable);
            currentTargetRoma = romaKeys[Math.floor(Math.random() * romaKeys.length)];
            currentTargetKana = romaTable[currentTargetRoma];
            scoreBoard.innerHTML = `ç¬¬ï¼’ã‚¹ãƒ†ãƒ¼ã‚¸ï¼: <span id="count">${stageCount}</span> / 60`;
        } else {
            const word = wordList[Math.floor(Math.random() * wordList.length)];
            currentTargetRoma = word.r;
            currentTargetKana = word.k;
            scoreBoard.innerHTML = `æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šä¿®è¡Œ: <span id="count">${stageCount}</span> / 10`;
        }
        renderTarget();
    }

    function renderTarget() {
        targetLettersEl.innerHTML = "";
        for (let i = 0; i < currentTargetRoma.length; i++) {
            const span = document.createElement('span');
            span.innerText = currentTargetRoma[i];
            span.className = (i < typedIndex ? 'done-key' : (i === typedIndex ? 'next-key' : ''));
            targetLettersEl.appendChild(span);
        }
        targetKanaEl.innerText = `ï¼ˆ${currentTargetKana}ï¼‰`;
        document.querySelectorAll('.key').forEach(k => k.classList.remove('target-hint'));
        document.getElementById('key-' + currentTargetRoma[typedIndex])?.classList.add('target-hint');
    }

    window.addEventListener('keydown', (e) => {
        if (!storyOverlay.classList.contains('hidden')) storyOverlay.classList.add('hidden');
        if (document.getElementById('name-form').style.display === 'block' || document.getElementById('final-screen').style.display === 'block') return;
        if (bannerEl.classList.contains('banner-active')) return;

        if (!startTime) startTime = new Date();
        const key = e.key.toUpperCase();
        
        // --- ã“ã“ã‹ã‚‰è¿½åŠ ï¼šã‚­ãƒ¼ãŒå…‰ã‚‹æ¼”å‡º ---
        const keyEl = document.getElementById('key-' + key);
        if (keyEl && key === currentTargetRoma[typedIndex]) {
            keyEl.classList.add('press-correct');
            // 0.1ç§’å¾Œã«å…ƒã®è‰²ã«æˆ»ã™
            setTimeout(() => {
                keyEl.classList.remove('press-correct');
            }, 100);
        }
        if (key === currentTargetRoma[typedIndex]) {
            typedIndex++;
            if (typedIndex >= currentTargetRoma.length) {
                // æ­£è§£ã—ãŸæ™‚
                combo++;
                updateComboDisplay();
                
                if (stage === 3) { 
                    stageCount++; 
                    speech.innerText = `ã€Œ${currentTargetKana}ï¼ã€`; 
                } else { 
                    totalCount++; 
                    stageCount++; 
                    // æ–‡å­—ã®é ­æ–‡å­—ã§åå¿œã‚’å¤‰ãˆã‚‹
                    monsterSpeak('eat', currentTargetRoma[0]); 
                }
                
                randomAppearance();
                updateMonsterLv();
                
                if (stage === 1 && totalCount >= 50) {
                    stage = 2; stageCount = 0;
                    document.querySelectorAll('.key').forEach(k => k.classList.add('visible'));
                    playEvolutionEffect("LEVEL UP!!", 2);
                } else if (stage === 2 && stageCount >= 60) { showNameForm(); }
                else if (stage === 3 && stageCount >= 10) { showFinalScreen(); }
                else { setTimeout(nextStep, 200); }
            } else { 
                renderTarget(); 
            }
        } else if (key.length === 1 && /^[A-Z]$/.test(key)) {
            missCount++; // â† ã“ã“ã‚’è¿½åŠ ï¼ãƒŸã‚¹ã‚’æ•°ãˆã‚‹
            combo = 0;
            updateComboDisplay();
            monsterSpeak('miss');
            speechTimer = setTimeout(() => { randomAppearance(); }, 800);
        }
    });

    function updateComboDisplay() {
        if (combo >= 2) {
            comboDisplay.innerText = combo + " COMBO!";
            comboDisplay.classList.add('combo-active');
        } else {
            comboDisplay.classList.remove('combo-active');
        }
    }

    function updateMonsterLv() {
        let lv = 0;
        if (stage === 1) {
            lv = Math.floor(totalCount / 10);
            monster.className = 'lv' + (lv > 10 ? 10 : lv);
            // â–¼ é€²åŒ–ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆ10, 20, 30å•...ï¼‰ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (totalCount % 10 === 0 && totalCount > 0) {
                speech.innerText = evolutionMessages[lv > 10 ? 10 : lv];
            }
        } else if (stage === 2) {
            monster.className = 'lv' + Math.floor(Math.random() * 11);
            if (isRare) monster.classList.add('rare-effect');
        } else {
            monster.className = 'lv' + Math.floor(Math.random() * 11);
            monster.classList.add('legendary');
            if (isRare) monster.classList.add('rare-effect');
        }
    }

    function showNameForm() {
        document.getElementById('play-screen').style.display = 'none';
        document.getElementById('name-form').style.display = 'block';
        if (isRare) document.getElementById('name-form-title').innerText = "âœ¨ è¶…ãƒ»æ¿€ãƒ¬ã‚¢ã—ã‚“ã‹ ãŠã‚ã§ã¨ã†ï¼ âœ¨";
        const container = document.getElementById('form-monster-container');
        container.innerHTML = "";
        const mClone = monster.cloneNode(true);
        const sClone = shadow.cloneNode(true);
        container.appendChild(mClone);
        container.appendChild(sClone);
    }

   function showFinalScreen() {
        const diff = (new Date() - startTime) / 1000;
        const prof = document.getElementById('m-prof').value || "ã‚„ã•ã—ã„";
        const skill = document.getElementById('m-skill').value || "ãªã—";
        const timeStr = `${Math.floor(diff/60)}åˆ† ${(diff%60).toFixed(1)}ç§’`;
        
        let finalName = monsterName;
        if (missCount === 0) {
            finalName = "âœ¨ç©¶æ¥µç¥âœ¨ " + monsterName;
            monster.classList.add('god-ray'); // ç¥ã€…ã—ãå…‰ã‚‰ã›ã‚‹
        }
       
        document.getElementById('res-name').innerText = monsterName + (isRare ? "ï¼ˆè¶…ãƒ¬ã‚¢ï¼‰" : "");
        document.getElementById('res-prof').innerText = prof;
        document.getElementById('res-skill').innerText = skill;
        document.getElementById('res-time').innerText = timeStr;
        
// --- ç§°å·ã®æ±ºå®šï¼ˆæ›¸ãæ›ãˆéƒ¨åˆ†ï¼‰ ---
        let shogo = "ç§°å·ï¼šâ˜˜ï¸ ã®ã‚“ã³ã‚Šè‚²æˆåäºº";

        if (missCount === 0 && maxCombo >= 100) {
            shogo = "ç§°å·ï¼šğŸŒŒ ä¼èª¬ã®ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒ»ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ»ã‚´ãƒƒãƒ‰";
        } else if (missCount === 0) {
            shogo = "ç§°å·ï¼šğŸŒŸ å¥‡è·¡ã®ãƒãƒ¼ãƒŸã‚¹ãƒ»ãƒã‚¹ã‚¿ãƒ¼";
        } else if (diff < 150) {
            shogo = "ç§°å·ï¼šâš¡ï¸ å…‰é€Ÿã®é€²åŒ–ç¥";
        } else if (diff < 300) {
            shogo = "ç§°å·ï¼šğŸ”¥ åŠªåŠ›ã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç‹";
        }

        if (isRare) shogo = "ğŸ‘‘ è¶…ãƒ¬ã‚¢ã®ä¸»ï¼ " + shogo;
        document.getElementById('res-shogo').innerText = shogo;
        // --- â˜…ã“ã“ã‹ã‚‰æ‰‹ç´™ã®å‡¦ç†â˜… ---
        const letters = [
            `ãã ã¦ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã£ãƒ”ï¼${prof}ãªã¼ãã®ã“ã¨ã€ã‚ã™ã‚Œãªã„ã§ã­ï¼`,
            `ã‚­ãƒŸã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã€ã‹ã£ã“ã‚ˆã‹ã£ãŸã£ãƒ”ï¼${monsterName}ã‚ˆã‚Šã€‚`,
            `ä¿®è¡Œã§ãã¦ã†ã‚Œã—ã‹ã£ãŸã£ãƒ”ï¼ã¾ãŸã‚ãã¼ã†ã­ï¼`,
            `${skill}ã®åŠ›ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚ã‚­ãƒŸã‚’å¿œæ´ã—ã¦ã‚‹ã£ã´ï¼`
        ];
        document.getElementById('letter-box').innerText = letters[Math.floor(Math.random() * letters.length)];
        // ------------------------------

        document.getElementById('play-screen').style.display = 'none';
        document.getElementById('final-screen').style.display = 'block';
        
        const container = document.getElementById('final-monster-container');
        container.innerHTML = "";
        const mClone = monster.cloneNode(true);
        const sClone = shadow.cloneNode(true);
        container.appendChild(mClone);
        container.appendChild(sClone);

        const finalBtn = document.querySelector('#final-screen button');
    if (count >= 10 && stage === 3) {
        finalBtn.innerText = "ä¼èª¬ã®è©¦ç·´ã«æŒ‘ã‚€ï¼";
        finalBtn.onclick = () => {
            document.getElementById('final-screen').style.display = 'none';
            document.getElementById('play-screen').style.display = 'block';
            stage = 4; stageCount = 0; playEvolutionEffect("FINAL TEST!", 4);
        };
    } else if (stage === 4) {
        finalBtn.innerText = "è¨€è‘‰ã‚’æ•™ãˆã‚‹ã£ã´ï¼";
        finalBtn.onclick = () => {
            document.getElementById('final-screen').style.display = 'none';
            document.getElementById('custom-word-form').style.display = 'block';
        };
    } else {
        finalBtn.onclick = () => location.reload();
    }

        saveToCollection(monsterName, monster.className, monster.style.backgroundColor, isRare);
    }

   function saveToCollection(name, className, bgColor, rare) {
        const collection = JSON.parse(localStorage.getItem('monsterCollection') || '[]');
        
        // ä»Šã®ãƒ‘ãƒ¼ãƒ„ã®çŠ¶æ…‹ã‚’ãƒ¡ãƒ¢ã™ã‚‹
        const currentParts = {
            armL: document.getElementById('arm-l').style.display,
            armR: document.getElementById('arm-r').style.display,
            wingL: document.getElementById('wing-l').style.display,
            wingR: document.getElementById('wing-r').style.display,
            eyeClass: eyeL.className,
            mouthClass: mouth.className
        };

        collection.push({ name, className, bgColor, rare, parts: currentParts });
        localStorage.setItem('monsterCollection', JSON.stringify(collection));
        loadCollection();
    }

    function loadCollection() {
        const grid = document.getElementById('collection-grid');
        grid.innerHTML = "";
        const collection = JSON.parse(localStorage.getItem('monsterCollection') || '[]');
        const count = collection.length;
        const badgeEl = document.getElementById('reward-badge');
        const progressEl = document.getElementById('reward-progress');

        if (count >= 10) { badgeEl.innerHTML = "ç§°å·ï¼šğŸ‘‘ ä¼èª¬ã®ã‚´ãƒƒãƒ‰ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼"; progressEl.innerText = "ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã ã£ã´ï¼"; }
        else if (count >= 5) { badgeEl.innerHTML = "ç§°å·ï¼šğŸŒŸ ä¸€æµãƒ–ãƒªãƒ¼ãƒ€ãƒ¼ã ã‚ã€œã‚“"; progressEl.innerText = `ã‚ã¨ ${10-count} åŒ¹ã§ä¼èª¬ã ã£ã´ï¼`; }
        else if (count >= 3) { badgeEl.innerHTML = "ç§°å·ï¼šğŸ’ª æœŸå¾…ã®ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼"; progressEl.innerText = `ã‚ã¨ ${5-count} åŒ¹ã§ä¸€æµã ã£ã´ï¼`; }
        else { badgeEl.innerHTML = "ç§°å·ï¼šğŸ¥š ãŸã¾ã”ãƒ–ãƒªãƒ¼ãƒ€ãƒ¼"; progressEl.innerText = `ã‚ã¨ ${3-count} åŒ¹ã§æœŸå¾…ã®æ˜Ÿã ã£ã´ï¼`; }

        collection.forEach(m => {
            const item = document.createElement('div');
            item.className = 'mini-monster';
            const rareClass = m.rare ? "rare-effect" : "";
            const rareBadge = m.rare ? '<div class="rare-badge">ULTRA</div>' : '';
            
            // ãƒ‘ãƒ¼ãƒ„ã®æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€ï¼ˆæ˜”ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã« `|| {}` ã‚’ã¤ã‘ã‚‹ï¼‰
            const p = m.parts || {};
            
            item.innerHTML = `
                ${rareBadge}
                <div class="mini-shape">
                    <div class="${m.className} ${rareClass}" style="background-color:${m.bgColor}; width:40px; height:100px; border-radius:10px; position:relative;">
                        <div class="${p.eyeClass || 'eye eye-l'}"></div>
                        <div class="${p.eyeClass || 'eye eye-r'}"></div>
                        <div class="${p.mouthClass || 'mouth'}"></div>
                        <div class="arm arm-l" style="display:${p.armL || 'none'}"></div>
                        <div class="arm arm-r" style="display:${p.armR || 'none'}"></div>
                        <div class="wing wing-l" style="display:${p.wingL || 'none'}"></div>
                        <div class="wing wing-r" style="display:${p.wingR || 'none'}"></div>
                    </div>
                </div>
                <div style="margin-top:25px;"><b>${m.name}</b></div>
            `;
            grid.appendChild(item);
        });
    }

    function clearCollection() {
        if(confirm("ãšã‹ã‚“ã‚’ç©ºã£ã½ã«ã™ã‚‹ã£ã´ï¼Ÿ")) {
            localStorage.removeItem('monsterCollection');
            loadCollection();
        }
    }

    document.getElementById('go-stage3-btn').onclick = () => {
        monsterName = document.getElementById('m-name').value || "åç„¡ã—ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼";
        document.getElementById('name-form').style.display = 'none';
        document.getElementById('play-screen').style.display = 'block';
        stage = 3; stageCount = 0;
        playEvolutionEffect("TRAINING!!", 3);
    };

    // â˜…è¿½åŠ ï¼šè¨€è‘‰ã‚’ä¿å­˜ã™ã‚‹ãƒœã‚¿ãƒ³
    document.getElementById('save-word-btn').onclick = () => {
        const k = document.getElementById('new-kana').value;
        const r = document.getElementById('new-roma').value;
        if (k && r) {
            const myWords = JSON.parse(localStorage.getItem('myCustomWords') || '[]');
            myWords.push({k, r});
            localStorage.setItem('myCustomWords', JSON.stringify(myWords));
             alert("è¨€è‘‰ã‚’æ•™ãˆãŸã£ã´ï¼");
             location.reload();
        }
      };    

    window.onload = () => {
        // â–¼ ã“ã“ã«ã€Œæœ€åˆã¯ã‚¹ãƒ†ãƒ¼ã‚¸1ã®èƒŒæ™¯ã«ã™ã‚‹ã€å‘½ä»¤ã‚’è¿½åŠ 
        document.body.className = 'stage1-bg'; 
        
        loadCollection();
        nextStep();
        setTimeout(() => { storyOverlay.classList.add('hidden'); }, 5000);
    };
</script>
</body>
</html>
